# CVE-2017-12635 : Case study and POC

Useful links:

- [https://www.cvedetails.com/cve/CVE-2017-12635/](https://www.cvedetails.com/cve/CVE-2017-12635/)
- [https://www.exploit-db.com/exploits/44498](https://www.exploit-db.com/exploits/44498)
- [https://justi.cz/security/2017/11/14/couchdb-rce-npm.html](https://justi.cz/security/2017/11/14/couchdb-rce-npm.html)

Prerequisites:

- [Docker](https://www.docker.com/)
- [cURL](https://curl.haxx.se/)

## Description

### CouchDB

Apache CouchDB is a document-oriented NoSQL database, implemented in Erlang.

CouchDB uses multiple formats and protocols to store, transfer, and process it's data, it uses JSON to store data, JavaScript as its query language using MapReduce, and HTTP for an API.

CouchDB can be used as a Single Node Database as well as a Cluster.

### Vulnerability

Due to the discrepancy between the Erlang-based JSON parser and JavaScript-based JSON parser, there was a vulnerability in CouchDB before 1.7.0 and 2.x before 2.1.1 allowing non-admin users to escalate privilege by submitting `_users` documents with duplicate `roles` keys used for access control within the databases, including the special case `_admin` role, that denotes administrative users.

To recap, the vulnerability allows non-admin users to give themselves admin privileges.

## More about CouchDB

### Validation Functions

CouchDB is written in Erlang, but allows users to specify document validation scripts in Javascript. These scripts are automatically evaluated when a document is created or updated. They start in a new process, and are passed JSON-serialized documents from the Erlang side.

CouchDB sends functions and documents to a JavaScript interpreter. This mechanism is what allows users to write document validation functions in JavaScript. The `validate_doc_update` function gets executed for each created or updated document. If the validation function raises an exception, the update is denied; when it doesn’t, the updates are accepted.

CouchDB uses the `validate_doc_update` function to prevent invalid or unauthorized document updates from proceeding.

```javascript
function(newDoc, oldDoc, userCtx, secObj) {...}
```

Arguments:

- `newDoc` – New version of document that will be stored
- `oldDoc` – Previous version of document that is already stored
- `userCtx` – User Context Object
- `srcObj` – Security Object

The function is passed the new document from the update request, the current document stored in the database, a `User Context Object` containing information about the user writing the document (if present), and a `Security Object` with lists of database security roles.

### JSON Parsers

The JSON parser used internally by CouchDB is [jiffy](https://github.com/davisp/jiffy) and the one used in validation scripts by JavaScript is [JSON](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON).

The problem is that there is a discrepancy between `JSON` and `jiffy` when dealing with duplicate keys.

For a given key, the Erlang parser will store both values, but the Javascript parser will only store the last one.

For example, parsing `{"name":"John", "name":"Jane"}` using both parsers will produce:

- Using `jiffy`: `{[{<<"name">>,<<"John">>},{<<"name">>,<<"Jane">>}]}`
- Using `JSON`: `{name: "Jane"}`
